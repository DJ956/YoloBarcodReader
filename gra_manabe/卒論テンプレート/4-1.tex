%第4-1章：実装
%手順（実験者のしたこと）


\section{実装}

第3章で述べた優先度の高い機能部分について実装を行った．本研究ではグループで開発を行った．サーバ側の精算システムを段原丞治が，Raspberry Piと各種センサを含むモビリティショッピング端末を筆者が実装した．Raspberry Pi はRaspberry Pi 3 Model Bを使用した．Raspberry Piの実装環境については下記，表\ref{rasp}に示す．


\begin{table}[htb]
\begin{center}
\caption{Raspberry Pi環境}
\begin{tabular}{|c||c|} \hline
使用機器 & Raspberry Pi3 Model B \\ \hline
OS & raspbian9 \\ \hline
CPU & 1.2GHz \\ \hline
メモリ & 1GB \\ \hline
\end{tabular}
\label{rasp}
\end{center}
\end{table}


Raspberry Piが制御した各種センサの実装環境について表\ref{jissou}に示す．


\begin{table}[htb]
\begin{center}
\caption{実装環境}
\begin{tabular}{|c|c|} \hline
センサ & 個数 \\ \hline \hline
ロジクール ウェブカメラ C615 & 1 \\
HY-SRF05超音波距離センサモジュール & 1 \\
ロードセル　シングルポイント(ビーム型)3kg & 1 \\
SODIAL(R) 100 5mm (LED) & 3 \\ \hline
\end{tabular}
\label{jissou}
\end{center}
\end{table}


上記のセンサをショッピングバスケットに取り付け，実装を行った．表\ref{jissou}に述べた各種センサの選定については3.3節に述べたとおりである．ショッピングバスケットのサイズは33L，寸法はW510×D360×H240mmである．ショッピングバスケットを以下カゴと呼ぶ．また，対象の商品として，小規模店舗，中規模店舗にも取り扱いがありそうな菓子としてDARSとコアラのマーチを選定した．

WebカメラはカゴのW510×D180×H150mmの位置に，カメラを底に向けて設置した．180×180mmのアクリル板をネジでロードセルに留め，Webカメラから100mm下に設置した．超音波センサの設置場所については，Webカメラと同じ高さの2種類の高さの両方の設置場所で実装した．LEDについては緑，青，赤の3色のLEDを抵抗と共にブレッドボードに設置した．

\subsection*{サーバとの通信}

ユーザが商品を追加，削除した際のみに，Webカメラより画像を撮る．画像データの後に追加もしくは削除のフラグをセットにしてサーバへ送信する．送信のタイミングは3.4節で述べたメッセージのとおりである．

\subsection*{各種センサの制御}

それぞれのセンサを制御するためにpythonを開発言語として使用した．センサを稼働し続けるためにはループ処理を行う必要がある．しかしながら，ループ外でセンサが閾値を超えたかどうかを確認する必要もあったため，センサの処理は別スレッドで動作させることとした．各センサは以下の動作をさせるよう実装した．

\noindent
{\bf ■超音波センサ}

商品，もしくは手を感知した際にフラグをたてる．システム起動の際，超音波センサからカゴの端までの距離を測り，その値を初期値とする．その初期値から値が減少していた場合フラグをたてる．ただし，初期値+30mmは誤差とする．

\noindent
{\bf ■Webカメラ}

超音波センサより，フラグがたった際に0.5秒に一度，合計6枚の画像を撮る．データ送信用配列にデータを追加する．

\noindent
{\bf ■ロードセル}

重量の増減を感知した際にフラグをたてる．増加したときに1のフラグを，減少したときに2のフラグをたてる．フラグをキューへ追加する．ただし，±3gの増減は誤差とする．

\noindent
{\bf ■LED}

超音波センサのフラグがたった時，画像撮影開始をユーザに知らせるために緑色のLEDを点灯させる．サーバへデータを送信後，バーコード情報を正しく読み取ることができたというフラグを受けとった際は青色のLEDを，読み取ることができなかったというフラグを受けとった際はユーザに再度商品の追加，削除を促すために赤色のLEDを点灯させる．

\newpage


%Raspberry Pi側でしたこと